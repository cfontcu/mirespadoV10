# Módulo   : VDINCIFACTURABLE.FRM
# Función  : MONITOR DE INCIDENCIAS
#
# Creación : 10-09-2009
# Autor    : JCSR
###########################################
# Histórico de cambios:
BEGINBLOQUE = VDINFINCIFACT.PAN
CAMPO = FECININUMERICO, AUXILIAR, OCULTO, "@L@@@@@"
CAMPO = FECFINNUMERICO, AUXILIAR, OCULTO, "@L@@@@@"

	PREREGISTRO = PRESEHIJO

  TECLA = F2, FEJECUTA ("CCALCULAFECHAS", "ERROR COPIANDO FECHAS", FPULSATECLAS("F6", "F2"), "")

  CURSOR = CCALCULAFECHAS SELECT :FECINI FECININUMERICO, :FECFIN FECFINNUMERICO FROM DUAL;
ENDBLOQUE
BEGINBLOQUE = VDINFGENINCI.PAN
	PREREGISTRO = PRESEHIJO
	PREQUERY = QUERYHIJO
WLONX=1200
TECLA = SF10, FEJECUTAFORM ("VDINCIDENCIAS", "S","CODINCI=:CODINCI","","DATOS DE LA INCIDENCIA :CODINCI")
SELECT = SELECT CODINCI,
                TO_CHAR(FLOOR (TIEMPOFACTURABLE/ 60)) || ' horas, '|| TO_CHAR(MOD(TIEMPOFACTURABLE,60)) || ' min.' HORASFACTURABLES,
                TO_CHAR(FLOOR (TIEMPONOFACTURABLE / 60)) || ' horas, '|| TO_CHAR(MOD(TIEMPONOFACTURABLE,60)) || ' min.' HORASNOFACTURABLES, 
				CODCLI,CODMANTENIMIENTO, DESCRIPCION, GRAVEDAD, FECCREADO, HORACREADO, FECCERRADO, HORACERRADO, PRESENCIAL , STATUS, CONTACTO,
                    TIEMPOFACTURABLE, TIEMPONOFACTURABLE
				FROM(
		SELECT INC.CODINCI,
				SUM(DECODE (NVL(INC.FACTURABLE, 'N'), 'S',ILO.TIEMPO, DECODE(ILO.FACTURABLE, 'S', ILO.TIEMPO, 0))) TIEMPOFACTURABLE, 
				SUM(DECODE (NVL(INC.FACTURABLE, 'N'), 'S',0, DECODE(ILO.FACTURABLE, 'N', ILO.TIEMPO, 0))) TIEMPONOFACTURABLE , 
				INC.CODCLI, INC.CODMANTENIMIENTO, INC.DESCRIPCION, INC.GRAVEDAD, INC.FECCREADO, INC.HORACREADO, 
				INC.FECCERRADO, INC.HORACERRADO, NVL(INC.PRESENCIAL, 'N') PRESENCIAL, INC.STATUS, INC.CONTACTO 
		   FROM VDINCICAB INC ,VDINCILINOPE ILO 
		  WHERE     ILO.CODINCI = INC.CODINCI 
		              AND (NVL(INC.FACTURABLE, 'N') = 'S' OR NVL(ILO.FACTURABLE, 'N') ='S')
                  AND (INC.CODCLI  = :CODCLIENTE OR :CODCLIENTE IS NULL)
                  AND STATUS = VDST.FINCIFACTURAN
                  AND (INC.FECCREADO BETWEEN :FECINI AND :FECFIN OR (:FECINI = 0 AND :FECFIN = 0))
         GROUP BY INC.CODINCI, INC.CODCLI, INC.CODMANTENIMIENTO, INC.DESCRIPCION, 
		        INC.GRAVEDAD, INC.FECCREADO, INC.HORACREADO, INC.FECCERRADO, INC.HORACERRADO, INC.PRESENCIAL, 
				INC.STATUS, INC.CONTACTO, INC.FACTURABLE 
	    ORDER BY CODINCI DESC);
PADRE = VDINFINCIFACT.PAN
	TITULO=DATOS DE INCIDENCIAS FACTURABLES
  TECLA = SF8, FEJECUTA(FIMPRIME("INFORME","HOJA DE FACTURACION DE INCIDENCIAS.RPT","FORMCODCLI=:CODCLIENTE;FORMFECINI=:FECININUMERICO;FORMFECFIN=:FECFINNUMERICO;FORMSTATUS=400","WINVIEW"),":V10ERROR")
  BOTON = IMPRIMIR,680,20,50,50,"Imprimir factura",fileprint.png,SF8,"Imprimir",INCLUDECSS="background-color: transparent;border-width:0px"
  TECLA = SF10, FEJECUTAFORM ("VDINCIDENCIAS", "S","CODINCI=:CODINCI","","DATOS DE LA INCIDENCIA :CODINCI")
  CAMPO = FECININUMERICO, AUXILIAR, OCULTO, VIRTUAL
  CAMPO = FECFINNUMERICO, AUXILIAR, OCULTO, VIRTUAL
POSY = 7	
  REGPAG = 35
  WLONY=590
#	SELECT = SELECT CODINCI,CODCLI,CODMANTENIMIENTO, DESCRIPCION, GRAVEDAD, FECCREADO, HORACREADO, FECCERRADO, HORACERRADO, 
#                TO_CHAR(FLOOR (TIEMPOFACTURABLE/ 60)) || ' horas, '|| TO_CHAR(MOD(TIEMPOFACTURABLE,60)) || ' min.' HORASFACTURABLES,
#                TO_CHAR(FLOOR (TIEMPONOFACTURABLE / 60)) || ' horas, '|| TO_CHAR(MOD(TIEMPONOFACTURABLE,60)) || ' min.' HORASNOFACTURABLES, 
#				PRESENCIAL , STATUS, CONTACTO FROM(
#		SELECT INC.CODINCI,
#				SUM(DECODE (NVL(INC.FACTURABLE, 'N'), 'S',ILO.TIEMPO, DECODE(ILO.FACTURABLE, 'S', ILO.TIEMPO, 0))) TIEMPOFACTURABLE, 
#				SUM(DECODE (NVL(INC.FACTURABLE, 'N'), 'S',0, DECODE(ILO.FACTURABLE, 'N', ILO.TIEMPO, 0))) TIEMPONOFACTURABLE , 
#				INC.CODCLI, INC.CODMANTENIMIENTO, INC.DESCRIPCION, INC.GRAVEDAD, INC.FECCREADO, INC.HORACREADO, 
#				INC.FECCERRADO, INC.HORACERRADO, NVL(INC.PRESENCIAL, 'N') PRESENCIAL, INC.STATUS, INC.CONTACTO 
#		   FROM VDINCICAB INC ,VDINCILINOPE ILO 
#		  WHERE ILO.CODINCI = INC.CODINCI AND STATUS = VDST.FINCIFACTURAN
#	   GROUP BY INC.CODINCI, INC.CODCLI, INC.CODMANTENIMIENTO, INC.DESCRIPCION, INC.GRAVEDAD, INC.FECCREADO, INC.HORACREADO, 
#		        INC.FECCERRADO, INC.HORACERRADO, INC.PRESENCIAL, INC.STATUS, INC.CONTACTO, INC.FACTURABLE, ILO.FACTURABLE 
#		 HAVING (INC.FACTURABLE = 'S' OR ILO.FACTURABLE = 'S')
#	    ORDER BY CODINCI DESC);

ENDBLOQUE
BEGINBLOQUE = VDTOTALESINCI.PAN
	PADRE = VDINFGENINCI.PAN
	PREQUERY = QUERYHIJO
NOENTER
SELECT = SELECT COUNT(DISTINCT INC.CODINCI) TOTALINCI, SUM(DECODE (NVL(INC.FACTURABLE, 'N'), 'S',ILO.TIEMPO, DECODE(ILO.FACTURABLE, 'S', ILO.TIEMPO, 0))) TOTALFACTURABLES, 
                SUM(DECODE (NVL(INC.FACTURABLE, 'N'), 'S',0, DECODE(ILO.FACTURABLE, 'N', ILO.TIEMPO, 0))) TOTALNOFACTURABLES
           FROM VDINCICAB INC ,VDINCILINOPE ILO 
          WHERE     ILO.CODINCI = INC.CODINCI 
                      AND (NVL(INC.FACTURABLE, 'N') = 'S' OR NVL(ILO.FACTURABLE, 'N') ='S')
                  AND (INC.CODCLI  = :CODCLIENTE OR :CODCLIENTE IS NULL)
                  AND STATUS = VDST.FINCIFACTURAN
                  AND (INC.FECCREADO BETWEEN :FECINI AND :FECFIN OR (:FECINI = 0 AND :FECFIN = 0));
	POSY = 45
  POSX = 122
  WMARCOFRAME
ENDBLOQUE
